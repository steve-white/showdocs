name: Build Multi-Platform

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            output: showdocs
            cc: gcc
          - os: macos-latest
            output: showdocs
            cc: gcc
          - os: windows-latest
            output: showdocs.exe
            cc: gcc
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Generate version number
      id: version
      shell: bash
      run: |
        # Get the count of commits as the patch version
        COMMIT_COUNT=$(git rev-list --count HEAD)
        
        # Check if this is a tagged release
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
        else
          # For non-tagged builds, use format: 1.0.<commit-count>-dev.<run-number>
          VERSION="1.0.${COMMIT_COUNT}-dev.${{ github.run_number }}"
        fi
        
        GIT_COMMIT=$(git rev-parse --short HEAD)
        BUILD_DATE=$(date -u '+%b %d %Y')
        BUILD_TIME=$(date -u '+%H:%M:%S')
        
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "GIT_COMMIT=$GIT_COMMIT" >> $GITHUB_OUTPUT
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_OUTPUT
        echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT
        
        echo "Building version: $VERSION (commit: $GIT_COMMIT)"
    
    - name: Set up GCC (Windows)
      if: runner.os == 'Windows'
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: mingw-w64-x86_64-gcc make
    
    - name: Build (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        ${{ matrix.cc }} -Wall -Wextra -std=c99 \
          -DVERSION='"${{ steps.version.outputs.VERSION }}"' \
          -DBUILD_DATE='"${{ steps.version.outputs.BUILD_DATE }}"' \
          -DBUILD_TIME='"${{ steps.version.outputs.BUILD_TIME }}"' \
          -DGIT_COMMIT='"${{ steps.version.outputs.GIT_COMMIT }}"' \
          -o ${{ matrix.output }} showdocs.c
        ls -lh ${{ matrix.output }}
        echo "Version check:"
        ./${{ matrix.output }} --version || true
    
    - name: Build (Windows)
      if: runner.os == 'Windows'
      shell: msys2 {0}
      run: |
        gcc -Wall -Wextra -std=c99 \
          -DVERSION='"${{ steps.version.outputs.VERSION }}"' \
          -DBUILD_DATE='"${{ steps.version.outputs.BUILD_DATE }}"' \
          -DBUILD_TIME='"${{ steps.version.outputs.BUILD_TIME }}"' \
          -DGIT_COMMIT='"${{ steps.version.outputs.GIT_COMMIT }}"' \
          -o ${{ matrix.output }} showdocs.c -lws2_32
        ls -lh ${{ matrix.output }}
    
    - name: Test binary exists
      run: |
        test -f ${{ matrix.output }}
        echo "âœ“ Binary built successfully: ${{ matrix.output }}"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: showdocs-${{ steps.version.outputs.VERSION }}-${{ runner.os }}-${{ runner.arch }}
        path: ${{ matrix.output }}
        retention-days: 30

  release:
    name: Create Release Assets
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Generate version number
      id: version
      run: |
        COMMIT_COUNT=$(git rev-list --count HEAD)
        if [[ "${{ github.ref_type }}" == "tag" ]]; then
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
        else
          VERSION="1.0.${COMMIT_COUNT}-dev.${{ github.run_number }}"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Display structure of downloaded files
      run: ls -R artifacts
    
    - name: Create Release Assets
      run: |
        mkdir -p release
        
        # Copy and rename binaries, then compress
        if [ -d "artifacts" ]; then
          find artifacts -type f -name "showdocs" -o -name "showdocs.exe" | while read file; do
            if [[ "$file" == *"Windows"* ]]; then
              cp "$file" "showdocs.exe"
              zip "release/showdocs-${{ steps.version.outputs.VERSION }}-windows-x64.zip" showdocs.exe
              rm showdocs.exe
            elif [[ "$file" == *"Linux"* ]]; then
              cp "$file" "showdocs"
              chmod +x "showdocs"
              tar -czf "release/showdocs-${{ steps.version.outputs.VERSION }}-linux-x64.tar.gz" showdocs
              rm showdocs
            elif [[ "$file" == *"macOS"* ]]; then
              cp "$file" "showdocs"
              chmod +x "showdocs"
              tar -czf "release/showdocs-${{ steps.version.outputs.VERSION }}-macos-x64.tar.gz" showdocs
              rm showdocs
            fi
          done
        fi
        
        ls -lh release/
    
    - name: Upload Release Assets
      uses: actions/upload-artifact@v4
      with:
        name: release-binaries-${{ steps.version.outputs.VERSION }}
        path: release/*
        retention-days: 90
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: release/*
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
